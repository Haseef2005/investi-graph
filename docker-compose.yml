services:
  
  # --- Frontend Service (React + Vite) ---
  frontend:
    build: 
      context: ./frontend
      dockerfile: Dockerfile
    container_name: investi_frontend
    ports:
      - "80:80"  # Map host port 80 to container port 80
    depends_on:
      - backend
    networks:
      - investi-network
    restart: unless-stopped

  # --- Backend Service (FastAPI) ---
  backend:
    build: 
      context: ./backend
      dockerfile: Dockerfile
    container_name: investi_backend
    ports:
      - "8000:8000"  # Map host port 8000 to container port 8000
    volumes:
      - ./backend:/app  # Mount code for development (optional: remove for production)
      - ./backend/uploads:/app/uploads  # Persist uploaded files
    environment:
      # Environment variables from .env file
      - PROJECT_NAME=${PROJECT_NAME}
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - JWT_ALGORITHM=${JWT_ALGORITHM}
      - ACCESS_TOKEN_EXPIRE_MINUTES=${ACCESS_TOKEN_EXPIRE_MINUTES}
      - DATABASE_HOST=db
      - DATABASE_USER=${DATABASE_USER:-postgres}
      - DATABASE_PASSWORD=${DATABASE_PASSWORD:-mysecretpassword}
      - DATABASE_NAME=${DATABASE_NAME:-postgres}
      - DATABASE_PORT=5432
      - DATABASE_URL=${DATABASE_URL}
      - PYTHONUNBUFFERED=1
      - LLM_PROVIDER=${LLM_PROVIDER}
      - LLM_API_KEY=${LLM_API_KEY}
      # Neo4j connection settings
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=mysecretneo4jpassword
      # SEC API Configuration
      - SEC_API_EMAIL=${SEC_API_EMAIL}
    depends_on:
      - db
      - neo4j
    networks:
      - investi-network
    restart: unless-stopped

  # --- PostgreSQL Database (with pgvector) ---
  db:
    image: pgvector/pgvector:pg15
    container_name: investi_db
    environment:
      POSTGRES_USER: ${DATABASE_USER:-postgres}
      POSTGRES_PASSWORD: ${DATABASE_PASSWORD:-mysecretpassword}
      POSTGRES_DB: ${DATABASE_NAME:-postgres}
    volumes:
      - postgres_data:/var/lib/postgresql/data  # Persist database data
    ports:
      - "5432:5432"  # Expose for external tools (optional)
    networks:
      - investi-network
    restart: unless-stopped

  # --- Neo4j Graph Database ---
  neo4j:
    image: neo4j:latest
    hostname: neo4j
    container_name: investi_neo4j
    ports:
      - "7474:7474"  # Browser interface
      - "7687:7687"  # Bolt protocol
    volumes:
      - neo4j_data:/data  # Persist graph data
    environment:
      # Set Neo4j authentication
      NEO4J_AUTH: neo4j/mysecretneo4jpassword
    networks:
      - investi-network
    restart: unless-stopped

# Named volumes for data persistence
volumes:
  postgres_data:
    driver: local
  neo4j_data:
    driver: local

# Custom network for inter-service communication
networks:
  investi-network:
    driver: bridge
